<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="WebRTC 1å¯¹1å®æ—¶éŸ³è§†é¢‘ç›´æ’­ BlogğŸ’¡ è®¾æƒ³ä¸€ä¸ªæƒ…æ™¯ï¼šç›¸éš”ä¸¤åœ°çš„Aå’ŒBï¼Œæƒ³è¿›è¡ŒéŸ³è§†é¢‘é€šä¿¡ã€‚åº”è¯¥æ€ä¹ˆå®ç°ï¼Ÿ å½“ç„¶ï¼Œå¯¹äºç°åœ¨çš„äººä»¬æ¥è¯´ï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šçš„æ‰‹æ®µï¼ŒåŒ…æ‹¬å¸¸è§çš„å³æ—¶é€šä¿¡å·¥å…·ï¼ˆQQã€å¾®ä¿¡ï¼‰ã€è…¾è®¯ä¼šè®®ã€é’‰é’‰ç­‰ï¼Œéƒ½å¯ä»¥è½»æ¾å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚ é‚£å¦‚æœç°åœ¨è®©ä½ ä»é›¶æ‰‹åŠ¨æ­å»ºä¸€å¥—è¿œç¨‹ä¸€å¯¹ä¸€çš„éŸ³è§†é¢‘é€šä¿¡ç³»ç»Ÿï¼Œåº”è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿ ä¸çŸ¥é“ä½ è„‘æµ·ä¸­æœ‰æ²¡æœ‰å®ç°çš„æ€è·¯ã€‚å¦‚æœå¯¹è¿™ä¸€é¢†åŸŸæ¯”è¾ƒé™Œç”Ÿçš„åŒå­¦ï¼Œæš‚æ—¶è«æ…Œï¼Œåœ¨ä¸‹è¾¹çš„æ–‡">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://leonardgsf.github.io/2024/04/16/WebRTC/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="WebRTC 1å¯¹1å®æ—¶éŸ³è§†é¢‘ç›´æ’­ BlogğŸ’¡ è®¾æƒ³ä¸€ä¸ªæƒ…æ™¯ï¼šç›¸éš”ä¸¤åœ°çš„Aå’ŒBï¼Œæƒ³è¿›è¡ŒéŸ³è§†é¢‘é€šä¿¡ã€‚åº”è¯¥æ€ä¹ˆå®ç°ï¼Ÿ å½“ç„¶ï¼Œå¯¹äºç°åœ¨çš„äººä»¬æ¥è¯´ï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šçš„æ‰‹æ®µï¼ŒåŒ…æ‹¬å¸¸è§çš„å³æ—¶é€šä¿¡å·¥å…·ï¼ˆQQã€å¾®ä¿¡ï¼‰ã€è…¾è®¯ä¼šè®®ã€é’‰é’‰ç­‰ï¼Œéƒ½å¯ä»¥è½»æ¾å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚ é‚£å¦‚æœç°åœ¨è®©ä½ ä»é›¶æ‰‹åŠ¨æ­å»ºä¸€å¥—è¿œç¨‹ä¸€å¯¹ä¸€çš„éŸ³è§†é¢‘é€šä¿¡ç³»ç»Ÿï¼Œåº”è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿ ä¸çŸ¥é“ä½ è„‘æµ·ä¸­æœ‰æ²¡æœ‰å®ç°çš„æ€è·¯ã€‚å¦‚æœå¯¹è¿™ä¸€é¢†åŸŸæ¯”è¾ƒé™Œç”Ÿçš„åŒå­¦ï¼Œæš‚æ—¶è«æ…Œï¼Œåœ¨ä¸‹è¾¹çš„æ–‡">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://leonardgsf.github.io/img/geek_webrtc.png">
<meta property="article:published_time" content="2024-04-16T00:15:22.000Z">
<meta property="article:modified_time" content="2024-04-16T10:36:25.774Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://leonardgsf.github.io/img/geek_webrtc.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://leonardgsf.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-WebRTC" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/04/16/WebRTC/" class="article-date">
  <time class="dt-published" datetime="2024-04-16T00:15:22.000Z" itemprop="datePublished">2024-04-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="WebRTC-1å¯¹1å®æ—¶éŸ³è§†é¢‘ç›´æ’­-Blog"><a href="#WebRTC-1å¯¹1å®æ—¶éŸ³è§†é¢‘ç›´æ’­-Blog" class="headerlink" title="WebRTC 1å¯¹1å®æ—¶éŸ³è§†é¢‘ç›´æ’­ Blog"></a>WebRTC 1å¯¹1å®æ—¶éŸ³è§†é¢‘ç›´æ’­ Blog</h1><p>ğŸ’¡ è®¾æƒ³ä¸€ä¸ªæƒ…æ™¯ï¼šç›¸éš”ä¸¤åœ°çš„Aå’ŒBï¼Œæƒ³è¿›è¡ŒéŸ³è§†é¢‘é€šä¿¡ã€‚åº”è¯¥æ€ä¹ˆå®ç°ï¼Ÿ</p>
<p>å½“ç„¶ï¼Œå¯¹äºç°åœ¨çš„äººä»¬æ¥è¯´ï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šçš„æ‰‹æ®µï¼ŒåŒ…æ‹¬å¸¸è§çš„å³æ—¶é€šä¿¡å·¥å…·ï¼ˆQQã€å¾®ä¿¡ï¼‰ã€è…¾è®¯ä¼šè®®ã€é’‰é’‰ç­‰ï¼Œéƒ½å¯ä»¥è½»æ¾å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<p>é‚£å¦‚æœç°åœ¨è®©ä½ ä»é›¶æ‰‹åŠ¨æ­å»ºä¸€å¥—è¿œç¨‹ä¸€å¯¹ä¸€çš„éŸ³è§†é¢‘é€šä¿¡ç³»ç»Ÿï¼Œåº”è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿ</p>
<p>ä¸çŸ¥é“ä½ è„‘æµ·ä¸­æœ‰æ²¡æœ‰å®ç°çš„æ€è·¯ã€‚å¦‚æœå¯¹è¿™ä¸€é¢†åŸŸæ¯”è¾ƒé™Œç”Ÿçš„åŒå­¦ï¼Œæš‚æ—¶è«æ…Œï¼Œåœ¨ä¸‹è¾¹çš„æ–‡ç« ä¸­æˆ‘ä»¬ä¼šé€æ­¥æ‹†è§£åŠä»‹ç»æ•´ä¸ªå®ç°æµç¨‹ã€‚å¸Œæœ›å­¦å®Œè¿™ä¸€è¯¾ç¨‹ï¼Œä½ ä¼šæœ‰ä¸€ä¸ªæ¯”è¾ƒæ¸…æ™°çš„è„‰ç»œå’Œå­¦åˆ°å¯è¡Œçš„å®è·µæ–¹æ¡ˆã€‚</p>
<p>è¯ä¸å¤šè¯´ï¼ŒLetâ€™s goï¼ è®©æˆ‘ä»¬å¼€å§‹ä»Šå¤©çš„è¿œç¨‹é€šä¿¡æ—…ç¨‹å§~</p>
<h2 id="èƒŒæ™¯æ¦‚è¦"><a href="#èƒŒæ™¯æ¦‚è¦" class="headerlink" title="èƒŒæ™¯æ¦‚è¦"></a>èƒŒæ™¯æ¦‚è¦</h2><ul>
<li>2011 å¹´ï¼ŒGoogle åˆ›ç«‹äº† WebRTC é¡¹ç›®ï¼Œå…¶æ„¿æ™¯å°±æ˜¯å¯ä»¥åœ¨æµè§ˆå™¨ä¹‹é—´å¿«é€Ÿåœ°å®ç°éŸ³è§†é¢‘é€šä¿¡ã€‚</li>
<li>WebRTCå®ç°äº†åŸºäºç½‘é¡µçš„è§†é¢‘ä¼šè®®ï¼Œæ ‡å‡†æ˜¯WHATWG åè®®ï¼Œç›®çš„æ˜¯é€šè¿‡æµè§ˆå™¨æä¾›ç®€å•çš„javascriptå°±å¯ä»¥è¾¾åˆ°å®æ—¶é€šè®¯ï¼ˆReal-Time Communications (RTC)ï¼‰èƒ½åŠ›ã€‚</li>
<li>WebRTCæä¾›äº†è§†é¢‘ä¼šè®®çš„æ ¸å¿ƒæŠ€æœ¯ï¼ŒåŒ…æ‹¬éŸ³è§†é¢‘çš„é‡‡é›†ã€ç¼–è§£ç ã€ç½‘ç»œä¼ è¾“ã€æ˜¾ç¤ºç­‰åŠŸèƒ½ï¼Œå¹¶ä¸”è¿˜æ”¯æŒè·¨å¹³å°ï¼šwindowsï¼Œlinuxï¼Œmacï¼Œandroidã€‚</li>
<li>æˆ‘ä»¬å‰æœŸä½¿ç”¨æ—¶çŸ¥é“åŸºæœ¬çš„APIå°±è¡Œï¼Œå¦‚æœæƒ³ç»§ç»­äº†è§£ï¼Œå¯ä»¥å‚ç…§ä»¥ä¸‹webrtcå®˜æ–¹æ–‡æ¡£ã€‚</li>
</ul>
<h2 id="æ­¥éª¤æ‹†è§£"><a href="#æ­¥éª¤æ‹†è§£" class="headerlink" title="æ­¥éª¤æ‹†è§£"></a>æ­¥éª¤æ‹†è§£</h2><ol>
<li>æ—¢ç„¶é€šä¿¡çš„å†…å®¹æ˜¯éŸ³è§†é¢‘ï¼Œè‚¯å®šéœ€è¦Aã€Bå„è‡ªçš„ç»ˆç«¯æ¥æ£€æµ‹ã€é‡‡é›†æœ¬åœ°çš„éŸ³è§†é¢‘ä¿¡æ¯ã€‚</li>
<li>é‡‡é›†å®Œæ¯•ä¹‹åï¼ŒAã€Béœ€è¦çŸ¥é“å¯¹æ–¹æ˜¯å¦åœ¨çº¿ï¼Œç¡®è®¤å¯¹æ–¹å·²ç»å‡†å¤‡å¥½æ¥æ”¶å’Œä¼ è¾“éŸ³è§†é¢‘æ•°æ®äº†ã€‚</li>
<li>Aã€BåŒæ–¹éœ€è¦æ²Ÿé€šè¿æ¥çš„ä¿¡æ¯åŠåè®®ï¼Œæ–¹ä¾¿å»ºç«‹é€šè·¯ã€‚åå•†éŸ³è§†é¢‘ç¼–è§£ç çš„æ ¼å¼ï¼Œæ–¹ä¾¿åç»­éŸ³è§†é¢‘æ¸²æŸ“å’Œæ’­æ”¾ã€‚</li>
<li>æ¥ä¸‹æ¥å°±æ˜¯æœ€é‡è¦çš„ç‚¹å¯¹ç‚¹è¿æ¥ç¯èŠ‚äº†ï¼ŒWebRTCæä¾›çš„RTCPeerConnectionä¼šå¸®æˆ‘ä»¬æå®šä¸€åˆ‡ã€‚</li>
<li>è¿æ¥å»ºç«‹åï¼ŒAã€Bçš„éŸ³è§†é¢‘æ•°æ®åœ¨è¿™æ¡è¿æ¥é€šè·¯ä¸Šè¦ä»¥ç›´æ¥æ–¹å¼å„è‡ªä¸é—´æ–­åœ°ä¼ è¾“åˆ°å¦ä¸€ç«¯ã€‚</li>
<li>å¦‚æœè¿™ä¸ªè¿æ¥é€šè·¯æ–­æ‰çš„è¯ï¼Œå¦‚ä½•ä¿éšœæ•°æ®èƒ½ç¨³å®šåˆ°è¾¾å¦ä¸€ç«¯å‘¢ï¼Ÿæ‰€ä»¥æˆ‘ä»¬è¿˜è¦æœ‰ä¸€ä¸ªä¸­ç»§æœåŠ¡å™¨è¾…åŠ©åŒæ–¹å®ŒæˆéŸ³è§†é¢‘æ•°æ®çš„ä¸­ç»§åŠäº¤æ¢ã€‚</li>
<li>æœ€åéŸ³è§†é¢‘ä¼ è¾“è¿‡æ¥ä¹‹åï¼Œè¦åœ¨å„è‡ªå®¢æˆ·ç«¯å†…è¿›è¡Œè§£ç ã€æ¸²æŸ“ã€æ’­æ”¾ã€‚</li>
</ol>
<p>ä¸ªäººç†è§£ï¼Œå®ç°æ•´ä¸ªæµç¨‹å°±æ˜¯æŠŠå„ä¸ªç»†åˆ†çš„ç¯èŠ‚è·‘é€šï¼Œæœ€åå°†æ‰€æœ‰ç¯èŠ‚è‡ªç„¶ä¸²è”è¿è½¬èµ·æ¥çš„æµç¨‹ã€‚æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ¸—é€åˆ°æ¯ä¸€ä¸ªç¯èŠ‚ä¸­å»åˆ†æè§£å†³æ–¹æ¡ˆã€‚</p>
<h3 id="è·å–æœ¬åœ°éŸ³è§†é¢‘ä¿¡æ¯"><a href="#è·å–æœ¬åœ°éŸ³è§†é¢‘ä¿¡æ¯" class="headerlink" title="è·å–æœ¬åœ°éŸ³è§†é¢‘ä¿¡æ¯"></a>è·å–æœ¬åœ°éŸ³è§†é¢‘ä¿¡æ¯</h3><ul>
<li>éŸ³è§†é¢‘é‡‡é›†åŸºæœ¬æ¦‚å¿µ<ul>
<li><strong>æ‘„åƒå¤´</strong>ã€‚ç”¨äºæ•æ‰ï¼ˆé‡‡é›†ï¼‰å›¾åƒå’Œè§†é¢‘ã€‚</li>
<li><strong>å¸§ç‡</strong>ã€‚ç°åœ¨çš„æ‘„åƒå¤´åŠŸèƒ½å·²éå¸¸å¼ºå¤§ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ç§’é’Ÿå¯ä»¥é‡‡é›† 30 å¼ ä»¥ä¸Šçš„å›¾åƒï¼Œä¸€äº›å¥½çš„æ‘„åƒå¤´ç”šè‡³å¯ä»¥é‡‡é›† 100 å¼ ä»¥ä¸Šã€‚æˆ‘ä»¬æŠŠ<strong>æ‘„åƒå¤´ä¸€ç§’é’Ÿé‡‡é›†å›¾åƒçš„æ¬¡æ•°ç§°ä¸ºå¸§ç‡</strong>ã€‚å¸§ç‡è¶Šé«˜ï¼Œè§†é¢‘å°±è¶Šå¹³æ»‘æµç•…ã€‚ç„¶è€Œï¼Œåœ¨ç›´æ’­ç³»ç»Ÿä¸­ä¸€èˆ¬ä¸ä¼šè®¾ç½®å¤ªé«˜çš„å¸§ç‡ï¼Œå› ä¸ºå¸§ç‡è¶Šé«˜ï¼Œå çš„ç½‘ç»œå¸¦å®½å°±è¶Šå¤šã€‚</li>
<li><strong>åˆ†è¾¨ç‡</strong>ã€‚æ‘„åƒå¤´é™¤äº†å¯ä»¥è®¾ç½®å¸§ç‡ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è°ƒæ•´åˆ†è¾¨ç‡ã€‚æˆ‘ä»¬å¸¸è§çš„åˆ†è¾¨ç‡æœ‰ 2Kã€1080Pã€720Pã€420P ç­‰ã€‚åˆ†è¾¨ç‡è¶Šé«˜å›¾åƒå°±è¶Šæ¸…æ™°ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œå³å ç”¨çš„å¸¦å®½ä¹Ÿå°±è¶Šå¤šã€‚æ‰€ä»¥ï¼Œåœ¨ç›´æ’­ç³»ç»Ÿä¸­ï¼Œåˆ†è¾¨ç‡çš„é«˜ä½ä¸ç½‘ç»œå¸¦å®½æœ‰ç´§å¯†çš„è”ç³»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ†è¾¨ç‡ä¼šè·Ÿæ®ä½ çš„ç½‘ç»œå¸¦å®½è¿›è¡ŒåŠ¨æ€è°ƒæ•´ã€‚</li>
<li><strong>å®½é«˜æ¯”</strong>ã€‚åˆ†è¾¨ç‡ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§å®½é«˜æ¯”ï¼Œå³ 16:9 æˆ– 4:3ã€‚4:3 çš„å®½é«˜æ¯”æ˜¯ä»é»‘ç™½ç”µè§†è€Œæ¥ï¼Œè€Œ 16:9 çš„å®½é«˜æ¯”æ˜¯ä»æ˜¾ç¤ºå™¨è€Œæ¥ã€‚ç°åœ¨ä¸€èˆ¬æƒ…å†µä¸‹éƒ½é‡‡ç”¨ 16:9 çš„æ¯”ä¾‹ã€‚</li>
<li><strong>éº¦å…‹é£</strong>ã€‚ç”¨äºé‡‡é›†éŸ³é¢‘æ•°æ®ã€‚å®ƒä¸è§†é¢‘ä¸€æ ·ï¼Œå¯ä»¥æŒ‡å®šä¸€ç§’å†…é‡‡æ ·çš„æ¬¡æ•°ï¼Œç§°ä¸º<strong>é‡‡æ ·ç‡</strong>ã€‚æ¯ä¸ªé‡‡æ ·ç”¨å‡ ä¸ª bit è¡¨ç¤ºï¼Œç§°ä¸º<strong>é‡‡æ ·ä½æ·±æˆ–é‡‡æ ·å¤§å°</strong>ã€‚</li>
<li><strong>è½¨ï¼ˆTrackï¼‰</strong>ã€‚WebRTC ä¸­çš„â€œè½¨â€å€Ÿé‰´äº†å¤šåª’ä½“çš„æ¦‚å¿µã€‚ç«è½¦è½¨é“çš„ç‰¹æ€§ä½ åº”è¯¥éå¸¸æ¸…æ¥šï¼Œä¸¤æ¡è½¨æ°¸è¿œä¸ä¼šç›¸äº¤ã€‚â€œè½¨â€åœ¨å¤šåª’ä½“ä¸­è¡¨è¾¾çš„å°±æ˜¯<strong>æ¯æ¡è½¨æ•°æ®éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šä¸å…¶ä»–è½¨ç›¸äº¤</strong>ï¼Œå¦‚ MP4 ä¸­çš„éŸ³é¢‘è½¨ã€è§†é¢‘è½¨ï¼Œå®ƒä»¬åœ¨ MP4 æ–‡ä»¶ä¸­æ˜¯è¢«åˆ†åˆ«å­˜å‚¨çš„ã€‚</li>
<li><strong>æµï¼ˆStreamï¼‰</strong>ã€‚å¯ä»¥ç†è§£ä¸ºå®¹å™¨ã€‚åœ¨ WebRTC ä¸­ï¼Œâ€œæµâ€å¯ä»¥åˆ†ä¸ºåª’ä½“æµï¼ˆMediaStreamï¼‰å’Œæ•°æ®æµï¼ˆDataStreamï¼‰ã€‚å…¶ä¸­ï¼Œåª’ä½“æµå¯ä»¥å­˜æ”¾ 0 ä¸ªæˆ–å¤šä¸ªéŸ³é¢‘è½¨æˆ–è§†é¢‘è½¨ï¼›æ•°æ®æµå¯ä»¥å­˜ 0 ä¸ªæˆ–å¤šä¸ªæ•°æ®è½¨ã€‚</li>
</ul>
</li>
<li>éŸ³è§†é¢‘é‡‡é›†API<ul>
<li><p>WebRTCæä¾›äº†ç®€å•æ¸…æ™°çš„APIæ¥è®¿é—®å’Œé‡‡é›†æœ¬åœ°éŸ³é¢‘è®¾å¤‡æˆ–å±å¹•ï¼Œå…·ä½“ä½¿ç”¨å¦‚ä¸‹</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é»˜è®¤é‡‡é›†éŸ³é¢‘ã€è§†é¢‘</span></span><br><span class="line"><span class="keyword">const</span> constraints = &#123;</span><br><span class="line">    <span class="string">&#x27;video&#x27;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&#x27;audio&#x27;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å®šåˆ¶åŒ–é‡‡é›†å‚æ•°</span></span><br><span class="line">    <span class="keyword">const</span> constraints = &#123;</span><br><span class="line">        <span class="string">&#x27;audio&#x27;</span>: &#123;<span class="string">&#x27;echoCancellation&#x27;</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">        <span class="string">&#x27;video&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;frameRate&#x27;</span>: <span class="number">15</span>, <span class="comment">//å¸§ç‡</span></span><br><span class="line">            <span class="string">&#x27;width&#x27;</span>: &#123;<span class="string">&#x27;min&#x27;</span>: <span class="number">640</span>&#125;, <span class="comment">//é‡‡é›†è§†é¢‘æœ€å°å®½åº¦</span></span><br><span class="line">            <span class="string">&#x27;height&#x27;</span>: &#123;<span class="string">&#x27;min&#x27;</span>: <span class="number">480</span>&#125; <span class="comment">//é‡‡é›†è§†é¢‘æœ€å°é«˜åº¦</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//é‡‡é›†ç”¨æˆ·éŸ³è§†é¢‘</span></span><br><span class="line">navigator.<span class="property">mediaDevices</span>.<span class="title function_">getUserMedia</span>(constraints)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">stream</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Got MediaStream:&#x27;</span>, stream);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error accessing media devices.&#x27;</span>, error);</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="comment">//é‡‡é›†ç”¨æˆ·å±å¹•æµ</span></span><br><span class="line">navigator.<span class="property">mediaDevices</span>.<span class="title function_">getDisplayMedia</span>(constraints)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">stream</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Got MediaStream:&#x27;</span>, stream);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error accessing media devices.&#x27;</span>, error);</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><p>getUserMedia&#x2F;getDisplayMediaä¼šè§¦å‘ä¸€ä¸ªæµè§ˆå™¨å¯¹ç”¨æˆ·æœ¬åœ°éŸ³è§†é¢‘è®¾å¤‡çš„æƒé™è¯·æ±‚ã€‚</p>
<ul>
<li>è‹¥ç”¨æˆ·æ¥å—ï¼Œåˆ™ä¼šæ ¹æ®constraintsè®¾ç½®çš„videoå’Œaudioé…ç½®ï¼Œæ¥é‡‡é›†å¯¹åº”çš„éŸ³é¢‘è½¨ã€è§†é¢‘è½¨ã€‚</li>
<li>è‹¥ç”¨æˆ·æ‹’ç»ï¼Œåˆ™ä¼šæŠ›å‡ºNotAllowedå¼‚å¸¸ï¼Œä¸€æ—¦æ²¡æœ‰å‘ç°å¯ç”¨çš„è®¾å¤‡ï¼Œåˆ™ä¼šæŠ›å‡ºNotFoundErrorå¼‚å¸¸ã€‚</li>
</ul>
</li>
<li><p>å…·ä½“APIç»†èŠ‚å¯å‚è€ƒå¦‚ä¸‹é“¾æ¥</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices">MediaDevices - Web APIs | MDN</a></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="ä¿¡ä»¤äº¤æ¢"><a href="#ä¿¡ä»¤äº¤æ¢" class="headerlink" title="ä¿¡ä»¤äº¤æ¢"></a>ä¿¡ä»¤äº¤æ¢</h3><p>åœ¨çº¿çŠ¶æ€ã€åª’ä½“ä¿¡æ¯ã€è¿æ¥ä¿¡æ¯ç­‰ï¼Œï¼ˆé€šè¿‡éƒ¨ç½²ä¿¡ä»¤æœåŠ¡å™¨å®Œæˆï¼Œåæ–‡ä¼šå±•å¼€ä»‹ç»ï¼‰</p>
<ul>
<li><p>å®ç°æˆ¿é—´ç®¡ç†ï¼ŒåŠ å…¥æˆ¿é—´ã€é€€å‡ºæˆ¿é—´ã€å‘é€å…¶ä»–æ¶ˆæ¯ç­‰ï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯äº’ç›¸æ˜ç¡®åœ¨çº¿çŠ¶æ€ã€‚</p>
</li>
<li><p>äº¤æ¢åª’ä½“åå•†æ•°æ®ï¼ˆéŸ³è§†é¢‘ç¼–ç åè®®ç­‰ï¼‰</p>
</li>
<li><p>äº¤æ¢ICEã€ŒInteractive Connectivity Establishmentã€ Candidateï¼ŒåŒ…å«è¿æ¥åè®®ã€IPã€ç«¯å£ç­‰</p>
<p>ICE Candidate ï¼ˆICE å€™é€‰è€…ï¼‰ã€‚å®ƒè¡¨ç¤º WebRTC ä¸è¿œç«¯é€šä¿¡æ—¶ä½¿ç”¨çš„åè®®ã€IP åœ°å€å’Œç«¯å£ï¼Œä¸€èˆ¬ç”±ä»¥ä¸‹å­—æ®µç»„æˆï¼šæœ¬åœ° IP åœ°å€æœ¬åœ°ç«¯å£å·å€™é€‰è€…ç±»å‹ï¼ŒåŒ…æ‹¬ hostã€srflx å’Œ relayä¼˜å…ˆçº§ä¼ è¾“åè®®è®¿é—®æœåŠ¡çš„ç”¨æˆ·åâ€¦â€¦</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  IP: xxx.xxx.xxx.xxx,</span><br><span class="line">  port: number,</span><br><span class="line">  <span class="built_in">type</span>: host/srflx/relay,</span><br><span class="line">  priority: number,</span><br><span class="line">  protocol: UDP/TCP,</span><br><span class="line">  usernameFragment: string</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="ç‚¹å¯¹ç‚¹è¿æ¥"><a href="#ç‚¹å¯¹ç‚¹è¿æ¥" class="headerlink" title="ç‚¹å¯¹ç‚¹è¿æ¥"></a>ç‚¹å¯¹ç‚¹è¿æ¥</h3><p>é€šä¿¡çš„åŒæ–¹éƒ½éœ€è¦æ–°å»ºä¸€ä¸ªRTCPeerConnectionå¯¹è±¡ï¼Œå®ç°ç‚¹å¯¹ç‚¹çš„P2Pè¿æ¥ã€‚RTCPeerConnectionå¯¹è±¡ä¸»è¦å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li><p>æ‰¿è½½æœ¬åœ°åŠè¿œç«¯éŸ³è§†é¢‘ç­‰æ•°æ®æµï¼Œé€šè¿‡ç‚¹å¯¹ç‚¹æˆ–è€…ä¸­ç»§çš„å½¢å¼å‘é€æ•°æ®ï¼ŒåŒæ—¶ç»‘å®šäº†ç›¸åº”çš„å›è°ƒå‡½æ•°ï¼Œå½“æœ‰è¿œç«¯çš„æ•°æ®æµåˆ°æ¥æ—¶ï¼Œæé†’ä¸šåŠ¡å±‚è¿›è¡Œåç»­æ¸²æŸ“æ“ä½œ</p>
</li>
<li><p>è‡ªåŠ¨è·å–åª’ä½“æè¿°ä¿¡æ¯SDPï¼ŒåŒæ—¶å­˜å‚¨é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨äº¤æ¢è·å–åˆ°çš„è¿œç«¯SDPä¿¡æ¯ã€‚</p>
</li>
<li><p>æ”¶é›†ICEï¼ˆInteractive Connectivity Establishmentï¼‰ Candidateã€‚åŒæ—¶å­˜å‚¨é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨äº¤æ¢è·å–åˆ°çš„è¿œç«¯ ICE Candidateä¿¡æ¯ï¼Œä»¥ä¾¿è¿›è¡Œç«¯ä¸ç«¯ä¹‹é—´çš„è¿æ¥</p>
<ul>
<li>host ç±»å‹ï¼Œå³æœ¬æœºå†…ç½‘çš„ IP å’Œç«¯å£ï¼›æœ€å®¹æ˜“æ‰‹æœºçš„Candidate</li>
<li>srflx ç±»å‹, é€šè¿‡STUNåè®®å®ç°ï¼Œå³æœ¬æœº NAT æ˜ å°„åçš„å¤–ç½‘çš„ IP å’Œç«¯å£ï¼›é€šè¿‡åœ¨å¤–ç½‘æ­å»ºä¸€ä¸ª STUN æœåŠ¡å™¨ï¼Œé€šè¿‡å‘æ•°æ®åŒ…çš„æ–¹å¼è·å–è‡ªå·±å¤–ç½‘IPå’Œç«¯å£<ul>
<li>relay ç±»å‹ï¼Œå³ä¸­ç»§æœåŠ¡å™¨çš„ IP å’Œç«¯å£ï¼›é€šè¿‡å‘ TURN æœåŠ¡å™¨å‘é€ Allocation æŒ‡ä»¤ï¼Œrelay æœåŠ¡å°±ä¼šåœ¨æœåŠ¡å™¨ç«¯åˆ†é…ä¸€ä¸ªæ–°çš„ relay ç«¯å£ï¼Œç”¨äºä¸¤ç«¯ä¸­è½¬ UDP æ•°æ®æŠ¥ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>NATç©¿è¶Šå»ºç«‹è¿æ¥ï¼ŒWebRTCåº•å±‚éƒ½å¸®æˆ‘ä»¬å®ç°äº†ï¼Œè¿™é‡Œä¸å±•å¼€ä»‹ç»äº†ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡æ¡£</p>
<p><a target="_blank" rel="noopener" href="https://blog.jianchihu.net/webrtc-av-transport-basis-nat-traversal.html">WebRTCéŸ³è§†é¢‘ä¼ è¾“åŸºç¡€ï¼šNATç©¿é€</a></p>
</li>
</ul>
<h3 id="æ•°æ®ä¸­è½¬"><a href="#æ•°æ®ä¸­è½¬" class="headerlink" title="æ•°æ®ä¸­è½¬"></a>æ•°æ®ä¸­è½¬</h3><p>ç‚¹å¯¹ç‚¹è¿æ¥å¤±è´¥çš„æ•°æ®ä¸­è½¬ï¼ˆé€šè¿‡TURNæœåŠ¡å™¨å®ç°ï¼‰</p>
<ul>
<li>åœ¨P2Pè¿æ¥å¤±è´¥æ—¶ï¼Œæä¾›æ•°æ®ä¸­ç»§æœåŠ¡æ—¶</li>
<li>åœ¨ICEäº¤æ¢çš„è¿‡ç¨‹ä¸­ï¼ŒååŠ©å®¢æˆ·ç«¯è·å–è‡ªå·±çš„å¤–ç½‘IPå’Œç«¯å£</li>
</ul>
<p>ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬è¿œç¨‹é€šä¿¡çš„å…³é”®æ­¥éª¤ï¼Œä¸‹å›¾å°±æ˜¯è¿™ä¸ªå®Œæ•´çš„æµç¨‹å‘ˆç°ã€‚å›¾ç‰‡æ¥æºäºæå®¢æ—¶é—´æè¶…è€å¸ˆçš„è¯¾ç¨‹<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100031801">ã€Šä»0æ‰“é€ éŸ³è§†é¢‘ç›´æ’­ç³»ç»Ÿã€‹</a></p>
<p><img src="/img/geek_webrtc.png" alt="ä¸€å¯¹ä¸€éŸ³è§†é¢‘é€šä¿¡æ¶æ„-æå®¢æ—¶é—´"></p>
<p>ä¸Šå›¾æ˜¯æ•´ä¸ª WebRTC 1 å¯¹ 1 éŸ³è§†é¢‘å®æ—¶é€šè¯çš„è¿‡ç¨‹å›¾ã€‚é€šè¿‡è¿™å¹…å›¾ï¼Œä½ å¯ä»¥çœ‹å‡ºè¦å®ç° 1 å¯¹ 1 éŸ³è§†é¢‘å®æ—¶é€šè¯å…¶è¿‡ç¨‹è¿˜æ˜¯è›®å¤æ‚çš„ã€‚</p>
<p>è¿™å¹…å›¾ä»å¤§çš„æ–¹é¢å¯ä»¥åˆ†ä¸º 4 éƒ¨åˆ†ï¼Œå³<strong>ä¸¤ä¸ª WebRTC ç»ˆç«¯</strong>ï¼ˆä¸Šå›¾ä¸­çš„ä¸¤ä¸ªå¤§æ–¹æ¡†ï¼‰ã€<strong>ä¸€ä¸ª Signalï¼ˆä¿¡ä»¤ï¼‰æœåŠ¡å™¨</strong>å’Œ<strong>ä¸€ä¸ª STUN&#x2F;TURN æœåŠ¡å™¨</strong>ã€‚</p>
<p>WebRTC ç»ˆç«¯ï¼Œè´Ÿè´£éŸ³è§†é¢‘é‡‡é›†ã€ç¼–è§£ç ã€NAT ç©¿è¶Šã€éŸ³è§†é¢‘æ•°æ®ä¼ è¾“ã€‚</p>
<p>Signal æœåŠ¡å™¨ï¼Œè´Ÿè´£ä¿¡ä»¤å¤„ç†ï¼Œå¦‚åŠ å…¥æˆ¿é—´ã€ç¦»å¼€æˆ¿é—´ã€åª’ä½“åå•†æ¶ˆæ¯çš„ä¼ é€’ç­‰ã€‚</p>
<p>STUN&#x2F;TURN æœåŠ¡å™¨ï¼Œè´Ÿè´£è·å– WebRTC ç»ˆç«¯åœ¨å…¬ç½‘çš„ IP åœ°å€ï¼Œä»¥åŠ NAT ç©¿è¶Šå¤±è´¥åçš„æ•°æ®ä¸­è½¬ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¾æ®ä¸Šè¾¹çš„æ•´ä½“æµç¨‹åŠç†è®ºæŒ‡å¯¼ï¼Œæ¥è¿›è¡Œå…·ä½“çš„å®ç°ç¯èŠ‚~</p>
<h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><h3 id="å‰ç½®å‡†å¤‡"><a href="#å‰ç½®å‡†å¤‡" class="headerlink" title="å‰ç½®å‡†å¤‡"></a>å‰ç½®å‡†å¤‡</h3><ul>
<li>2Må¸¦å®½ä»¥ä¸Šçš„äº‘ä¸»æœº+åŸŸå+httpsè¯ä¹¦<ul>
<li>ä¸ç®¡æ˜¯æ­å»ºä¿¡ä»¤å’Œä¸­ç»§æœåŠ¡å™¨ã€è¿˜æ˜¯æä¾›å®¢æˆ·ç«¯åœ¨æµè§ˆå™¨è®¿é—®åŒä¸€å¥—é€šä¿¡ä»£ç ï¼Œéƒ½éœ€è¦ä¸€å°äº‘ä¸»æœºã€‚</li>
<li>ä¸ºä½•éœ€è¦ 2M ä»¥ä¸Šå¸¦å®½çš„å¸¦å®½å‘¢ï¼Ÿï¼Œå¯¹äºä¸€è·¯ 720P çš„è§†é¢‘ï¼Œä¸€èˆ¬æƒ…å†µä¸‹éœ€è¦ 1.2M çš„å¸¦å®½ï¼Œå› æ­¤åœ¨ä¸¤äººé€šä¿¡æ—¶ï¼Œå¦‚æœéƒ½èµ°æœåŠ¡å™¨ä¸­è½¬çš„è¯å°±éœ€è¦ 2.4M çš„å¸¦å®½äº†ã€‚æ‰€ä»¥ä¸ºäº†ä¿è¯åŒæ–¹é€šä¿¡é¡ºç•…ï¼Œå¸¦å®½æ˜¯å¿…é¡»è¦èƒ½è·Ÿå¾—ä¸Šçš„ã€‚</li>
<li>å› ä¸ºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œè®¿é—®éŸ³è§†é¢‘æ—¶ï¼Œéƒ½éœ€è¦ç›¸åº”çš„httpsè¯ä¹¦ï¼Œæ‰€ä»¥åŸŸåå’Œhttpsè¯ä¹¦éƒ½æ˜¯éœ€è¦å‡†å¤‡çš„ã€‚</li>
</ul>
</li>
</ul>
<h3 id="æœåŠ¡å™¨ç¯å¢ƒéƒ¨ç½²"><a href="#æœåŠ¡å™¨ç¯å¢ƒéƒ¨ç½²" class="headerlink" title="æœåŠ¡å™¨ç¯å¢ƒéƒ¨ç½²"></a>æœåŠ¡å™¨ç¯å¢ƒéƒ¨ç½²</h3><ul>
<li><p>webæœåŠ¡å™¨æ­å»º</p>
<ul>
<li><p>ä¸»è¦æ˜¯ç»™å®¢æˆ·ç«¯(æµè§ˆå™¨)æä¾›æ‰§è¡Œçš„æ–‡ä»¶(htmlã€cssã€js)ï¼Œæˆ‘ä»¬ç¤ºä¾‹ä¸­ç”¨Node.jsæ¥å®ç°ï¼Œä¸»è¦æ˜¯è€ƒè™‘åˆ°åç»­ä¿¡ä»¤æœåŠ¡ä¾èµ–äºNode.jsã€‚ä¸‹è¾¹æ˜¯ä»£ç ç¤ºä¾‹ï¼Œæˆ‘ä»¬æš‚å‘½åä¸ºserver.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> https = <span class="built_in">require</span>(<span class="string">&#x27;https&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> serveIndex = <span class="built_in">require</span>(<span class="string">&#x27;serve-index&#x27;</span>);</span><br><span class="line">...</span><br><span class="line"><span class="comment">//ä½¿ç”¨expresså®ç°WEBæœåŠ¡</span></span><br><span class="line"><span class="keyword">var</span> app = <span class="title function_">express</span>(); </span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">serveIndex</span>(<span class="string">&#x27;./public&#x27;</span>));</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(<span class="string">&#x27;./public&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//HTTPS è¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">  key : fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./cert/yourrtc.cn.key&#x27;</span>),</span><br><span class="line">  <span class="attr">cert</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./cert/yourrtc.cn.pem&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//https server</span></span><br><span class="line"><span class="keyword">var</span> https_server = https.<span class="title function_">createServer</span>(options, app);</span><br><span class="line"><span class="keyword">var</span> io = socketIo.<span class="title function_">listen</span>(https_server);</span><br><span class="line">https_server.<span class="title function_">listen</span>(<span class="number">443</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>â€‹</p>
</li>
</ul>
</li>
<li><p>ä¿¡ä»¤æœåŠ¡æ­å»º</p>
<ul>
<li><p>æˆ‘ä»¬åŒæ ·ä½¿ç”¨Node.jsæ¥æ­å»ºä¿¡ä»¤æœåŠ¡å™¨ï¼Œä»£ç å¯ä»¥æ”¾åœ¨ä¸Šè¿°çš„server.jsä¸­ï¼Œåªéœ€æ·»åŠ socketçš„æœåŠ¡ç«¯éƒ¨åˆ†å³å¯</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">&#x27;node-static&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> file = <span class="title function_">new</span>(<span class="keyword">static</span>.<span class="property">Server</span>)();</span><br><span class="line"><span class="keyword">const</span> app = http.<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  file.<span class="title function_">serve</span>(req, res);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">2013</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> io = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>).<span class="title function_">listen</span>(app); <span class="comment">//ä¾¦å¬ 2013</span></span><br><span class="line"></span><br><span class="line">io.<span class="property">sockets</span>.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">socket</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// convenience function to log server messages to the client</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">log</span>(<span class="params"></span>)&#123; </span><br><span class="line">    <span class="keyword">const</span> array = [<span class="string">&#x27;&gt;&gt;&gt; Message from server: &#x27;</span>]; </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      array.<span class="title function_">push</span>(<span class="variable language_">arguments</span>[i]);</span><br><span class="line">    &#125; </span><br><span class="line">      socket.<span class="title function_">emit</span>(<span class="string">&#x27;log&#x27;</span>, array);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  socket.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">message</span>) =&gt;</span> &#123; <span class="comment">//æ”¶åˆ°messageæ—¶ï¼Œè¿›è¡Œå¹¿æ’­</span></span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;Got message:&#x27;</span>, message);</span><br><span class="line">    <span class="comment">// for a real app, would be room only (not broadcast)</span></span><br><span class="line">    socket.<span class="property">broadcast</span>.<span class="title function_">emit</span>(<span class="string">&#x27;message&#x27;</span>, message); <span class="comment">//åœ¨çœŸå®çš„åº”ç”¨ä¸­ï¼Œåº”è¯¥åªåœ¨æˆ¿é—´å†…å¹¿æ’­</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  socket.<span class="title function_">on</span>(<span class="string">&#x27;create or join&#x27;</span>, <span class="function">(<span class="params">room</span>) =&gt;</span> &#123; <span class="comment">//æ”¶åˆ° â€œcreate or joinâ€ æ¶ˆæ¯</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> clientsInRoom = io.<span class="property">sockets</span>.<span class="property">adapter</span>.<span class="property">rooms</span>[room];</span><br><span class="line">    <span class="keyword">var</span> numClients = clientsInRoom ? <span class="title class_">Object</span>.<span class="title function_">keys</span>(clientsInRoom.<span class="property">sockets</span>).<span class="property">length</span> : <span class="number">0</span>; <span class="comment">//æˆ¿é—´é‡Œçš„äººæ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;Room &#x27;</span> + room + <span class="string">&#x27; has &#x27;</span> + numClients + <span class="string">&#x27; client(s)&#x27;</span>);</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;Request to create or join room &#x27;</span> + room);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (numClients === <span class="number">0</span>)&#123; <span class="comment">//å¦‚æœæˆ¿é—´é‡Œæ²¡äºº</span></span><br><span class="line">      socket.<span class="title function_">join</span>(room);</span><br><span class="line">      socket.<span class="title function_">emit</span>(<span class="string">&#x27;created&#x27;</span>, room); <span class="comment">//å‘é€ &quot;created&quot; æ¶ˆæ¯</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (numClients === <span class="number">1</span>) &#123; <span class="comment">//å¦‚æœæˆ¿é—´é‡Œæœ‰ä¸€ä¸ªäºº</span></span><br><span class="line">    io.<span class="property">sockets</span>.<span class="title function_">in</span>(room).<span class="title function_">emit</span>(<span class="string">&#x27;join&#x27;</span>, room);</span><br><span class="line">      socket.<span class="title function_">join</span>(room);</span><br><span class="line">      socket.<span class="title function_">emit</span>(<span class="string">&#x27;joined&#x27;</span>, room); <span class="comment">//å‘é€ â€œjoinedâ€æ¶ˆæ¯</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// max two clients</span></span><br><span class="line">      socket.<span class="title function_">emit</span>(<span class="string">&#x27;full&#x27;</span>, room); <span class="comment">//å‘é€ &quot;full&quot; æ¶ˆæ¯</span></span><br><span class="line">    &#125;</span><br><span class="line">    socket.<span class="title function_">emit</span>(<span class="string">&#x27;emit(): client &#x27;</span> + socket.<span class="property">id</span> +</span><br><span class="line">      <span class="string">&#x27; joined room &#x27;</span> + room);</span><br><span class="line">    socket.<span class="property">broadcast</span>.<span class="title function_">emit</span>(<span class="string">&#x27;broadcast(): client &#x27;</span> + socket.<span class="property">id</span> +</span><br><span class="line">      <span class="string">&#x27; joined room &#x27;</span> + room);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>turnæœåŠ¡å™¨æ­å»º</p>
<ul>
<li>turnæœåŠ¡å™¨ä¸»è¦æ˜¯ç”¨æ¥åœ¨ç‚¹å¯¹ç‚¹è¿æ¥å¤±è´¥çš„æ—¶å€™ï¼Œè¿›è¡Œæ•°æ®ä¸­ç»§è½¬å‘çš„ã€‚åŒæ—¶ä¹Ÿå¯ç”¨äºå¸®åŠ©å®¢æˆ·ç«¯è·å–è‡ªå·±çš„å¤–ç½‘IPåœ°å€å’Œç«¯å£ï¼ŒååŠ©å®¢æˆ·ç«¯å»ºç«‹ç‚¹å¯¹ç‚¹çš„è¿æ¥ã€‚</li>
<li>æˆ‘ä»¬é‡‡ç”¨ç›®å‰æœ€è‘—åçš„TurnæœåŠ¡å™¨ï¼Œç”±Google å‘èµ·çš„å¼€æºé¡¹ç›®coturnï¼Œåœ°å€ä¸º<a target="_blank" rel="noopener" href="https://github.com/coturn/coturn">coturn</a>ï¼Œ</li>
<li>å®‰è£…coturn<ul>
<li>ä» <a target="_blank" rel="noopener" href="https://github.com/coturn/coturn">https://github.com/coturn/coturn</a> ä¸‹è½½ coturn ä»£ç ï¼›</li>
<li>æ‰§è¡Œ .&#x2F;configure â€“prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;coturn ç”Ÿæˆ Makefileï¼›</li>
<li>æ‰§è¡Œ make æ¥ç¼–è¯‘ coturnï¼›</li>
<li>æ‰§è¡Œ sudo make install è¿›è¡Œå®‰è£…ã€‚</li>
</ul>
</li>
<li>é…ç½®coturn<ul>
<li><p>ç¼–è¾‘coturnçš„é…ç½®æ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/coturn/turnserver.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹ä»¥ä¸‹å››é¡¹é…ç½®å³å¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user=use:pas #è¿æ¥turnæœåŠ¡å™¨çš„ç”¨æˆ·åå’Œå¯†ç </span><br><span class="line">realm=yourrtc.cn #è®¾ç½®ä¸ºä½ çš„è®¿é—®åŸŸå</span><br><span class="line">listening-port=3478 #ç›‘å¬ç«¯å£ï¼Œå›ºå®šä¸º3478</span><br><span class="line">external-ip=1.2.3.55 #æ›´æ¢ä¸ºä½ çš„å…¬ç½‘IP</span><br></pre></td></tr></table></figure>

<p>â€‹</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="å®¢æˆ·ç«¯ä»£ç ç¼–å†™éƒ¨ç½²"><a href="#å®¢æˆ·ç«¯ä»£ç ç¼–å†™éƒ¨ç½²" class="headerlink" title="å®¢æˆ·ç«¯ä»£ç ç¼–å†™éƒ¨ç½²"></a>å®¢æˆ·ç«¯ä»£ç ç¼–å†™éƒ¨ç½²</h3><ul>
<li>å®¢æˆ·ç«¯ä½¿ç”¨ä¿¡ä»¤æœåŠ¡,å»ºç«‹client.jsæ–‡ä»¶</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> isInitiator;</span><br><span class="line"></span><br><span class="line">room = <span class="title function_">prompt</span>(<span class="string">&#x27;Enter room name:&#x27;</span>); <span class="comment">//å¼¹å‡ºä¸€ä¸ªè¾“å…¥çª—å£</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> socket = io.<span class="title function_">connect</span>(); <span class="comment">//ä¸æœåŠ¡ç«¯å»ºç«‹socketè¿æ¥</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (room !== <span class="string">&#x27;&#x27;</span>) &#123; <span class="comment">//å¦‚æœæˆ¿é—´ä¸ç©ºï¼Œåˆ™å‘é€ &quot;create or join&quot; æ¶ˆæ¯</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Joining room &#x27;</span> + room);</span><br><span class="line">  socket.<span class="title function_">emit</span>(<span class="string">&#x27;create or join&#x27;</span>, room);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//socketçš„messageæ¶ˆæ¯æ˜¯ä¸»è¦çš„äº¤æ¢æ¸ é“ï¼Œäº¤æ¢åŒæ–¹çš„åª’ä½“ä¿¡æ¯åŠè¿æ¥ä¿¡æ¯</span></span><br><span class="line">socket.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">roomid, data</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;receive message!&#x27;</span>, roomid, data);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(data === <span class="literal">null</span> || data === <span class="literal">undefined</span>)&#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;the message is invalid!&#x27;</span>);</span><br><span class="line">		<span class="keyword">return</span>;	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(data.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;type&#x27;</span>) &amp;&amp; data.<span class="property">type</span> === <span class="string">&#x27;offer&#x27;</span>) &#123;</span><br><span class="line">		</span><br><span class="line">		offer.<span class="property">value</span> = data.<span class="property">sdp</span>;</span><br><span class="line"></span><br><span class="line">		pc.<span class="title function_">setRemoteDescription</span>(<span class="keyword">new</span> <span class="title class_">RTCSessionDescription</span>(data));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//create answer</span></span><br><span class="line">		pc.<span class="title function_">createAnswer</span>()</span><br><span class="line">			.<span class="title function_">then</span>(getAnswer)</span><br><span class="line">			.<span class="title function_">catch</span>(handleAnswerError);</span><br><span class="line"></span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(data.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;type&#x27;</span>) &amp;&amp; data.<span class="property">type</span> == <span class="string">&#x27;answer&#x27;</span>)&#123;</span><br><span class="line">		answer.<span class="property">value</span> = data.<span class="property">sdp</span>;</span><br><span class="line">		pc.<span class="title function_">setRemoteDescription</span>(<span class="keyword">new</span> <span class="title class_">RTCSessionDescription</span>(data));</span><br><span class="line">	</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span> (data.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;type&#x27;</span>) &amp;&amp; data.<span class="property">type</span> === <span class="string">&#x27;candidate&#x27;</span>)&#123;</span><br><span class="line">		<span class="keyword">var</span> candidate = <span class="keyword">new</span> <span class="title class_">RTCIceCandidate</span>(&#123;</span><br><span class="line">			<span class="attr">sdpMLineIndex</span>: data.<span class="property">label</span>,</span><br><span class="line">			<span class="attr">candidate</span>: data.<span class="property">candidate</span></span><br><span class="line">		&#125;);</span><br><span class="line">		pc.<span class="title function_">addIceCandidate</span>(candidate);	</span><br><span class="line">	</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;the message is invalid!&#x27;</span>, data);</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">socket.<span class="title function_">on</span>(<span class="string">&#x27;join&#x27;</span>, <span class="function">(<span class="params">room</span>) =&gt;</span> &#123; <span class="comment">//å¦‚æœä»æœåŠ¡ç«¯æ”¶åˆ° â€œjoin&quot; æ¶ˆæ¯</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Making request to join room &#x27;</span> + room);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;You are the initiator!&#x27;</span>);</span><br><span class="line">  <span class="comment">//æ ¹æ®ä¿¡ä»¤æœåŠ¡çš„é€šçŸ¥æ¥å»ºç«‹ç›¸åº”çš„è¿æ¥åŠç»‘å®šæµï¼Œåç»­æœ‰ç¤ºä¾‹</span></span><br><span class="line">  <span class="title function_">createPeerConnection</span>(); <span class="comment">//åŠ å…¥æˆ¿é—´æˆåŠŸåï¼Œå¼€å§‹å»ºç«‹PeerConnectionå¯¹è±¡</span></span><br><span class="line">  <span class="title function_">bindTracks</span>(); <span class="comment">//ç»‘å®šç›¸åº”çš„æµ</span></span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">socket.<span class="title function_">on</span>(<span class="string">&#x27;log&#x27;</span>, <span class="function">(<span class="params">array</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="property">log</span>.<span class="title function_">apply</span>(<span class="variable language_">console</span>, array);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//å®šä¹‰å®¢æˆ·ç«¯å‘é€socketæ¶ˆæ¯çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sendMessage</span>(<span class="params">roomid, data</span>)&#123;</span><br><span class="line"></span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;send message to other end&#x27;</span>, roomid, data);</span><br><span class="line">	<span class="keyword">if</span>(!socket)&#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;socket is null&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	socket.<span class="title function_">emit</span>(<span class="string">&#x27;message&#x27;</span>, roomid, data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¡«å†™æœ¬åœ°çš„åª’ä½“ä¿¡æ¯ï¼Œå¹¶é€šè¿‡ä¿¡ä»¤æœåŠ¡å‘é€åˆ°è¿œç«¯ï¼Œé€‚åˆå½“å‰å®¢æˆ·ç«¯ä¸ºåˆå§‹å‘èµ·è€…ã€‚</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getOffer</span>(<span class="params">desc</span>)&#123;</span><br><span class="line">	pc.<span class="title function_">setLocalDescription</span>(desc);</span><br><span class="line">	offer.<span class="property">value</span> = desc.<span class="property">sdp</span>;</span><br><span class="line">	offerdesc = desc;</span><br><span class="line">	<span class="comment">//send offer sdp</span></span><br><span class="line">	<span class="title function_">sendMessage</span>(roomid, offerdesc);	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ”¶åˆ°è¿œç«¯çš„åª’ä½“ä¿¡æ¯æ—¶ï¼Œå»ºç«‹æœ¬å®¢æˆ·ç«¯åº”ç­”çš„åª’ä½“ä¿¡æ¯ï¼Œå¹¶å‘é€åˆ°è¿œç«¯ï¼Œé€‚åˆå½“å‰å®¢æˆ·ç«¯ä¸ºåº”ç­”è€…</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getAnswer</span>(<span class="params">desc</span>)&#123;</span><br><span class="line">	pc.<span class="title function_">setLocalDescription</span>(desc);</span><br><span class="line">	answer.<span class="property">value</span> = desc.<span class="property">sdp</span>;</span><br><span class="line">	<span class="comment">//send answer sdp</span></span><br><span class="line">	<span class="title function_">sendMessage</span>(roomid, desc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>å®¢æˆ·ç«¯ç»“åˆturnæœåŠ¡å™¨ï¼Œè¿›è¡Œç‚¹å¯¹ç‚¹çš„è¿æ¥ä¸æµçš„ä¼ è¾“ï¼Œä¹Ÿåœ¨client.jsç¼–å†™</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰turnæœåŠ¡å™¨çš„åŸºç¡€é…ç½®ï¼Œä¸ä¸Šæ–‡ä¸­coturnæœåŠ¡å™¨çš„é…ç½®ä¸€è‡´å³å¯ã€‚</span></span><br><span class="line"><span class="keyword">var</span> pcConfig = &#123;</span><br><span class="line">  <span class="string">&#x27;iceServers&#x27;</span>: [&#123; <span class="comment">//æŒ‡å®š ICE æœåŠ¡å™¨ä¿¡ä»¤</span></span><br><span class="line">    <span class="string">&#x27;urls&#x27;</span>: <span class="string">&#x27;turn:stun.al.learningrtc.cn:3478&#x27;</span>, <span class="comment">//turnæœåŠ¡å™¨åœ°å€ï¼Œéœ€è¦åŠ `turn:`çš„å›ºå®šå‰ç¼€</span></span><br><span class="line">    <span class="string">&#x27;credential&#x27;</span>: <span class="string">&quot;passwd&quot;</span>, <span class="comment">//turnæœåŠ¡å™¨å¯†ç ï¼Œä½ è¦ç”¨è‡ªå·±çš„ </span></span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>: <span class="string">&quot;username&quot;</span>  <span class="comment">//turnæœåŠ¡å™¨ç”¨æˆ·åï¼Œä½ è¦ç”¨è‡ªå·±çš„</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å»ºç«‹RTCPeerConnectionå¯¹è±¡ï¼Œæ³¨å†Œæ”¶åˆ°æ•°æ®æµçš„å›è°ƒäº‹ä»¶</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createPeerConnection</span>(<span class="params"></span>)&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span>(!pc)&#123;</span><br><span class="line">    pc = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>(pcConfig); <span class="comment">//åˆ›å»ºpeerconnectionå¯¹è±¡</span></span><br><span class="line">    ...</span><br><span class="line">    pc.<span class="property">ontrack</span> = getRemoteStream; <span class="comment">//å½“è¿œç«¯çš„trackåˆ°æ¥æ—¶ä¼šè§¦å‘è¯¥äº‹ä»¶</span></span><br><span class="line">  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;the pc have be created!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å½“è¿œç¨‹éŸ³è§†é¢‘æµæ•°æ®ä¼ è¾“å®Œæˆçš„æ—¶å€™ï¼Œè¿›è¡Œæ¸²æŸ“æ’­æ”¾æ“ä½œ</span></span><br><span class="line"><span class="keyword">var</span> remoteVideo = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;video#remotevideo&#x27;</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getRemoteStream</span>(<span class="params">e</span>)&#123;  <span class="comment">//äº‹ä»¶å¤„ç†å‡½æ•°</span></span><br><span class="line">  remoteStream = e.<span class="property">streams</span>[<span class="number">0</span>]; <span class="comment">//ä¿å­˜è¿œç«¯çš„æµ</span></span><br><span class="line">  remoteVideo.<span class="property">srcObject</span> = e.<span class="property">streams</span>[<span class="number">0</span>]; <span class="comment">//ä¸HTMLä¸­çš„è§†é¢‘æ ‡ç­¾ç»‘å®š</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æŠŠæœ¬åœ°çš„åª’ä½“æµæ·»åŠ åˆ°RTCPeerConnectionå¯¹è±¡é‡Œè¾¹ï¼Œä¾›åç»­è¿œç¨‹ä¼ è¾“</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bindTracks</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="comment">//add all track into peer connection</span></span><br><span class="line">  localStream.<span class="title function_">getTracks</span>().<span class="title function_">forEach</span>(<span class="function">(<span class="params">track</span>)=&gt;</span>&#123;</span><br><span class="line">    pc.<span class="title function_">addTrack</span>(track, localStream); <span class="comment">//å°†trackä¸peerconnectionç»‘å®š</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>å†æ·»åŠ ä¸€äº›é™æ€ä»£ç ï¼Œæ–¹ä¾¿æ¸²æŸ“å’Œé¢„è§ˆæœ¬åœ°åŠè¿œç«¯çš„éŸ³è§†é¢‘</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;connserver&quot;</span>&gt;</span>Connect Sig Server<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;start&quot;</span> <span class="attr">disabled</span>&gt;</span>Start<span class="tag">&lt;/<span class="name">button</span>&gt;</span>	</span><br><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;call&quot;</span> <span class="attr">disabled</span>&gt;</span>Call<span class="tag">&lt;/<span class="name">button</span>&gt;</span>	</span><br><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;hangup&quot;</span> <span class="attr">disabled</span>&gt;</span>HangUp<span class="tag">&lt;/<span class="name">button</span>&gt;</span>	</span><br><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;leave&quot;</span> <span class="attr">disabled</span>&gt;</span>Leave<span class="tag">&lt;/<span class="name">button</span>&gt;</span>	</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;shareDesk&quot;</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;shareDesk&quot;</span>&gt;</span>Share Desktop<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;preview&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">width</span>=<span class="string">&quot;40%&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h2</span>&gt;</span>Local:<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">&quot;localvideo&quot;</span> <span class="attr">autoplay</span> <span class="attr">playsinline</span> <span class="attr">muted</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h2</span>&gt;</span>Offer SDP:<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;offer&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: none;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">width</span>=<span class="string">&quot;40%&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h2</span>&gt;</span>Remote:<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">&quot;remotevideo&quot;</span> <span class="attr">autoplay</span> <span class="attr">playsinline</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h2</span>&gt;</span>Answer SDP:<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;answer&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: none;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Chat:<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;chat&quot;</span> <span class="attr">disabled</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;sendtxt&quot;</span> <span class="attr">disabled</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;send&quot;</span> <span class="attr">disabled</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»¥ä¸Šå°±æ˜¯æµè§ˆå™¨ç«¯å®ç° 1 å¯¹ 1 å®æ—¶é€šè¯çš„æ•´ä½“é€»è¾‘ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å¼•å…¥äº†WebRTCè¿™é¡¹æŠ€æœ¯ï¼Œå¹¶é€æ­¥æ‹†è§£äº†é€šä¿¡çš„åŸºæœ¬æ­¥éª¤å’Œè¦ç´ ï¼Œæœ€åå†æŠŠæ•´ä½“çš„è¿è¡Œç¯å¢ƒå’Œé€šä¿¡æ¨¡å—å±•å¼€ä»‹ç»ã€‚</p>
<p>ä¸å¾—ä¸è¯´ï¼Œæ¶‰åŠåˆ°çš„æŠ€æœ¯å’Œæœ¯è¯­çŸ¥è¯†è¿˜æ˜¯å¾ˆå¤šçš„ï¼Œé‰´äºèƒ½åŠ›å’Œç¯‡å¹…æœ‰é™ï¼Œæ­¤ç¯‡æ–‡ç« æ— æ³•æ·±å…¥åˆ°ä¼—å¤šçš„çŸ¥è¯†ç‚¹ï¼Œæ¯”å¦‚NATç©¿è¶Šç­‰ã€‚å¦‚æœä½ å¯¹éŸ³è§†é¢‘é€šä¿¡æ„Ÿå…´è¶£çš„è¯ï¼Œå¸Œæœ›è¿™ç¯‡åšå®¢èƒ½å¸®åŠ©ä½ ç†æ¸…æ€è·¯ï¼Œå¸®ä½ å…¥é—¨ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100031801?tab=catalog">æå®¢æ—¶é—´-æè¶…è€å¸ˆ-ä» 0 æ‰“é€ éŸ³è§†é¢‘ç›´æ’­ç³»ç»Ÿ</a></p>
<p><a target="_blank" rel="noopener" href="https://webrtc.org/getting-started/overview">Getting started with WebRTC</a></p>
<p><a target="_blank" rel="noopener" href="https://webrtc.github.io/webrtc-org/start/">WebRTCè¿›é˜¶</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/avdance/webrtc_web">WebRTC-demo</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://leonardgsf.github.io/2024/04/16/WebRTC/" data-id="clv28v1sr0000whs69f9ca26v" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2023/07/28/article-title/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hammerspoon  ä¸€æ¬¾Macä¸Šæå‡ä½ å·¥ä½œå­¦ä¹ æ•ˆç‡çš„ç¥å™¨</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/04/16/WebRTC/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/07/28/article-title/">Hammerspoon  ä¸€æ¬¾Macä¸Šæå‡ä½ å·¥ä½œå­¦ä¹ æ•ˆç‡çš„ç¥å™¨</a>
          </li>
        
          <li>
            <a href="/2023/07/28/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>